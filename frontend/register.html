<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pescarias - Registrar</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <script>
    fetch('menu.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('menu').innerHTML = data;
        initMenuAuth();
      });
  </script>
  <nav id="menu" class="navbar navbar-expand-lg bg-body-tertiary fixed-top"></nav>

  <main class="container" style="padding-top:80px; max-width:720px;">
    <h2>Registrar</h2>
    <div id="alert-placeholder"></div>

    <form id="register-form">
      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="username" class="form-label">Usuário</label>
          <input id="username" class="form-control" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="email" class="form-label">E-mail</label>
          <input id="email" type="email" class="form-control" required>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="password" class="form-label">Senha</label>
          <input id="password" type="password" class="form-control" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="role" class="form-label">Papel</label>
          <input id="role" class="form-control" value="USER" required>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-3">
          <label for="nome" class="form-label">Nome</label>
          <input id="nome" class="form-control" required>
        </div>
        <div class="col-md-6 mb-3">
          <label for="sobrenome" class="form-label">Sobrenome</label>
          <input id="sobrenome" class="form-control" required>
        </div>
      </div>

      <button class="btn btn-primary" type="submit">Registrar</button>
      <a class="btn btn-link" href="login.html">Já tenho conta</a>
    </form>
  </main>

  <script>
    document.getElementById('register-form').addEventListener('submit', async function (e) {
      e.preventDefault();
      const payload = {
        username: document.getElementById('username').value,
        email: document.getElementById('email').value,
        password: document.getElementById('password').value,
        role: document.getElementById('role').value || 'USER',
        nome: document.getElementById('nome').value,
        sobrenome: document.getElementById('sobrenome').value
      };

      try {
        const res = await fetch('http://localhost:8080/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (res.status === 201) {
          // redirect to login with success flag
          location.href = 'login.html?registered=1';
          return;
        } else {
          const text = await res.text();
          showAlert('danger', text || 'Erro ao registrar');
        }
      } catch (err) {
        showAlert('danger', 'Erro de conexão ao servidor');
      }
    });

    function showAlert(type, msg) {
      document.getElementById('alert-placeholder').innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    }
  </script>
</body>

</html>
